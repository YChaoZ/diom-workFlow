# DIOM Workflow 生产环境架构设计

## 📋 文档信息

- **版本**: v1.0.0
- **创建日期**: 2025-11-15
- **适用环境**: 生产环境
- **维护人**: [技术团队]

---

## 🏗️ 系统架构

### 1. 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户访问层                                │
│  浏览器 / 移动端 / 第三方系统                                     │
└─────────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                    负载均衡器 (可选)                             │
│             Nginx / HAProxy / 阿里云SLB                         │
│  功能: 流量分发、SSL卸载、健康检查                                │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                      前端服务器集群                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │  服务器 A   │  │  服务器 B   │  │  服务器 C   │           │
│  │  Nginx      │  │  Nginx      │  │  Nginx      │           │
│  │  静态文件   │  │  静态文件   │  │  静态文件   │           │
│  │  反向代理   │  │  反向代理   │  │  反向代理   │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────────────────────────┘
                            ↓ HTTP
┌─────────────────────────────────────────────────────────────────┐
│                   统一应用网关层                                  │
│  ┌──────────────────────────────────────────────────┐          │
│  │         Spring Cloud Gateway                      │          │
│  │  - 路由转发                                       │          │
│  │  - 统一认证 (JWT验证)                             │          │
│  │  - 限流熔断                                       │          │
│  │  - 日志追踪                                       │          │
│  │  - CORS处理                                       │          │
│  └──────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                      微服务层                                     │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────────┐ │
│  │  认证服务      │  │  Web层服务     │  │  工作流服务      │ │
│  │  Auth Service  │  │  Web Service   │  │ Workflow Service │ │
│  │  - 用户管理    │  │  - Dubbo消费者 │  │  - Camunda引擎  │ │
│  │  - JWT生成     │  │  - 业务编排    │  │  - 流程管理     │ │
│  │  - RBAC权限    │  │  - 接口聚合    │  │  - 任务调度     │ │
│  │  - Dubbo提供者 │  └────────────────┘  │  - 通知中心     │ │
│  └────────────────┘                     └──────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                            ↓ Dubbo RPC
┌─────────────────────────────────────────────────────────────────┐
│                    服务治理层                                     │
│  ┌──────────────────────────────────────────────────┐          │
│  │              Nacos 注册中心                       │          │
│  │  - 服务注册发现                                   │          │
│  │  - 配置管理                                       │          │
│  │  - 健康检查                                       │          │
│  │  - 元数据管理                                     │          │
│  └──────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储层                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────────┐ │
│  │  MySQL主库     │  │  MySQL从库     │  │  Redis缓存       │ │
│  │  - 业务数据    │  │  - 读写分离    │  │  - Session共享   │ │
│  │  - Camunda数据 │  │  - 数据备份    │  │  - 限流计数      │ │
│  └────────────────┘  └────────────────┘  └──────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 核心流程

### 2.1 用户登录认证流程

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 用户 │────▶│ Frontend │────▶│ Gateway  │────▶│   Auth   │
│      │     │ (Vue.js) │     │          │     │ Service  │
└──────┘     └──────────┘     └──────────┘     └──────────┘
                                                      │
                                                      ▼
                                                 验证用户名密码
                                                      │
                                                      ▼
                                                  生成JWT Token
                                                      │
                                                      ▼
                                             ┌────────────────┐
                                             │ 返回Token + 用户信息 │
                                             └────────────────┘
```

**详细步骤**:
1. 用户在前端输入用户名密码
2. 前端发送POST请求到 `/auth/login`
3. Gateway验证请求合法性，转发到Auth Service
4. Auth Service验证用户名密码（BCrypt）
5. 生成JWT Token（有效期1小时）
6. 返回Token和用户基本信息
7. 前端将Token存储到Cookie
8. 后续请求携带Token在Header中

### 2.2 工作流发起流程

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 用户 │────▶│ Frontend │────▶│ Gateway  │────▶│ Workflow │
│      │     │          │     │  + JWT   │     │ Service  │
└──────┘     └──────────┘     │  验证    │     └──────────┘
                               └──────────┘           │
                                                      ▼
                                              解析BPMN流程
                                                      │
                                                      ▼
                                              创建流程实例
                                                      │
                                                      ▼
                                              分配第一个任务
                                                      │
                                                      ▼
                                              发送任务通知
                                                      │
                                                      ▼
                                             ┌────────────────┐
                                             │  返回流程实例ID  │
                                             └────────────────┘
```

### 2.3 Dubbo RPC调用流程

```
┌────────────┐                    ┌────────────┐
│    Web     │                    │    Auth    │
│  Service   │                    │  Service   │
│ (Consumer) │                    │ (Provider) │
└────────────┘                    └────────────┘
      │                                  │
      │  1. 从Nacos获取服务列表           │
      │◀─────────────────────────────────│
      │                                  │
      │  2. 发起Dubbo RPC调用             │
      ├─────────────────────────────────▶│
      │     getUserInfo(username)        │
      │                                  │
      │  3. 返回用户信息                  │
      │◀─────────────────────────────────│
      │                                  │
```

---

## 🌐 网络架构

### 3.1 网络分层

```
┌──────────────────────────────────────────────────────────┐
│  DMZ区（外网可访问）                                       │
│  - 负载均衡器: 公网IP                                      │
│  - 前端服务器: 内网IP + 公网映射                            │
└──────────────────────────────────────────────────────────┘
                         │
                         ▼ 防火墙
┌──────────────────────────────────────────────────────────┐
│  应用层（内网）                                            │
│  - Gateway: 172.16.1.10:8080                             │
│  - Auth Service: 172.16.1.11:8081                        │
│  - Web Service: 172.16.1.12:8082                         │
│  - Workflow Service: 172.16.1.13:8085                    │
└──────────────────────────────────────────────────────────┘
                         │
                         ▼ 防火墙
┌──────────────────────────────────────────────────────────┐
│  服务治理层（内网）                                         │
│  - Nacos: 172.16.2.10:8848                               │
└──────────────────────────────────────────────────────────┘
                         │
                         ▼ 防火墙
┌──────────────────────────────────────────────────────────┐
│  数据层（内网）                                            │
│  - MySQL主: 172.16.3.10:3306                             │
│  - MySQL从: 172.16.3.11:3306                             │
│  - Redis: 172.16.3.20:6379                               │
└──────────────────────────────────────────────────────────┘
```

### 3.2 端口规划

| 层级 | 服务 | 内网端口 | 外网访问 | 说明 |
|------|------|---------|---------|------|
| **前端层** | Frontend-A | 80/443 | ✅ | Nginx |
| **前端层** | Frontend-B | 80/443 | ✅ | Nginx |
| **前端层** | Frontend-C | 80/443 | ✅ | Nginx |
| **网关层** | Gateway | 8080 | ❌ | 仅内网 |
| **应用层** | Auth Service | 8081 | ❌ | 仅内网 |
| **应用层** | Web Service | 8082 | ❌ | 仅内网 |
| **应用层** | Workflow Service | 8085 | ❌ | 仅内网 |
| **服务治理** | Nacos | 8848 | ❌ | 仅内网 |
| **数据层** | MySQL | 3306 | ❌ | 仅内网 |
| **数据层** | Redis | 6379 | ❌ | 仅内网 |

---

## 💾 数据架构

### 4.1 数据库设计

**数据库**: `diom_workflow`  
**字符集**: UTF8MB4  
**排序规则**: utf8mb4_unicode_ci

#### 核心表结构

| 表名 | 说明 | 行数估算 |
|------|------|---------|
| `sys_user` | 系统用户 | 1K |
| `sys_role` | 系统角色 | 10 |
| `sys_permission` | 系统权限 | 50 |
| `sys_user_role` | 用户角色关联 | 1K |
| `sys_role_permission` | 角色权限关联 | 100 |
| `workflow_definition` | 流程定义 | 100 |
| `workflow_instance` | 流程实例 | 10K |
| `workflow_task` | 流程任务 | 50K |
| `workflow_notification` | 流程通知 | 100K |
| `workflow_template` | 流程模板 | 50 |
| `workflow_draft` | 流程草稿 | 500 |
| `workflow_process_design` | 流程设计 | 50 |
| `workflow_process_design_history` | 流程设计历史 | 200 |
| **Camunda表** | （约30张表） | - |

### 4.2 数据备份策略

**备份策略**:
- **全量备份**: 每天凌晨2:00
- **增量备份**: 每4小时一次
- **保留策略**: 
  - 全量备份保留30天
  - 增量备份保留7天
- **异地备份**: 每周同步到异地机房

**备份脚本** (示例):
```bash
#!/bin/bash
# 全量备份
mysqldump -uroot -p${DB_PASSWORD} \
  --single-transaction \
  --routines --triggers --events \
  diom_workflow | gzip > backup_$(date +%Y%m%d).sql.gz

# 上传到OSS
ossutil cp backup_$(date +%Y%m%d).sql.gz oss://backup/mysql/
```

---

## 🔐 安全架构

### 5.1 认证授权

**认证方式**: JWT (JSON Web Token)

**JWT Payload**:
```json
{
  "sub": "username",
  "roles": ["SUPER_ADMIN"],
  "permissions": ["WORKFLOW_START", "WORKFLOW_TASK"],
  "iat": 1700000000,
  "exp": 1700003600
}
```

**权限模型**: RBAC (Role-Based Access Control)

```
User ──┬──> Role ──┬──> Permission
       │           │
       └──> Role ──┴──> Permission
```

### 5.2 安全加固措施

| 层级 | 措施 | 说明 |
|------|------|------|
| **网络层** | 防火墙规则 | 只开放必要端口 |
| **网络层** | IP白名单 | 限制访问来源 |
| **应用层** | JWT Token | 1小时过期 |
| **应用层** | 限流 | 防止API滥用 |
| **应用层** | SQL注入防护 | MyBatis参数化查询 |
| **应用层** | XSS防护 | 前端输入过滤 |
| **数据层** | 密码加密 | BCrypt |
| **数据层** | 敏感数据加密 | AES-256 |
| **传输层** | HTTPS | SSL/TLS 1.3 |

---

## 📊 监控架构

### 6.1 监控指标

**服务监控**:
- JVM内存使用率
- GC频率和耗时
- 线程数和线程池状态
- CPU使用率
- 响应时间(P50, P95, P99)

**业务监控**:
- API调用量(QPS)
- API成功率
- 流程启动数
- 任务完成数
- 用户活跃数

**基础设施监控**:
- 服务器CPU、内存、磁盘
- 网络流量
- 数据库连接数
- MySQL慢查询

### 6.2 日志管理

**日志级别**:
- 开发环境: DEBUG
- 测试环境: INFO
- 生产环境: INFO (可动态调整为DEBUG)

**日志路径**:
```
/var/log/diom-workflow/
├── gateway/
│   ├── gateway.log           # 应用日志
│   ├── gateway-error.log     # 错误日志
│   └── access.log            # 访问日志
├── auth-service/
│   └── auth.log
├── web-service/
│   └── web.log
└── workflow-service/
    └── workflow.log
```

**日志轮转**:
- 单个文件最大100MB
- 保留最近30天
- 总大小限制10GB

---

## 🚀 性能优化

### 7.1 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API响应时间(P95) | < 500ms | 95%的请求 |
| API响应时间(P99) | < 1s | 99%的请求 |
| QPS | > 1000 | 每秒请求数 |
| 并发用户数 | > 500 | 同时在线用户 |
| 系统可用性 | > 99.9% | 年故障时间<9小时 |

### 7.2 性能优化措施

**数据库优化**:
- 合理的索引设计
- 读写分离
- 连接池优化(HikariCP)
- 慢查询监控和优化

**缓存策略**:
- Redis缓存热点数据
- 用户Session共享
- 流程定义缓存
- 本地缓存(Caffeine)

**JVM调优**:
```bash
-Xms2g -Xmx2g              # 堆内存2G
-XX:+UseG1GC               # 使用G1垃圾回收器
-XX:MaxGCPauseMillis=200   # GC停顿时间<200ms
-XX:+HeapDumpOnOutOfMemoryError  # OOM时生成堆转储
```

---

## 📈 扩展性设计

### 8.1 水平扩展

**可水平扩展的组件**:
- ✅ 前端服务器（Nginx）
- ✅ Gateway
- ✅ Auth Service
- ✅ Web Service
- ✅ Workflow Service

**扩展方法**:
1. 增加服务器实例
2. Nacos自动注册
3. Gateway自动负载均衡

### 8.2 垂直扩展

**可垂直扩展的组件**:
- MySQL数据库（升级配置）
- Redis缓存（升级配置）
- 服务器硬件（CPU/内存）

---

## 🆘 容灾方案

### 9.1 高可用设计

**单点故障消除**:
- 前端: 多台Nginx服务器
- Gateway: 多实例部署
- 微服务: 多实例部署
- Nacos: 集群模式(3节点)
- MySQL: 主从复制

### 9.2 故障恢复

**RTO (Recovery Time Objective)**: < 1小时  
**RPO (Recovery Point Objective)**: < 4小时

**恢复流程**:
1. 监控告警
2. 故障定位
3. 启动备用服务
4. 数据恢复
5. 服务验证

---

**文档维护**: 请定期更新本文档以反映架构变更

