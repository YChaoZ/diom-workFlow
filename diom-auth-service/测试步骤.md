# diom-auth-service æµ‹è¯•æ­¥éª¤

## å‰ææ¡ä»¶
- âœ… MySQL åœ¨ Docker ä¸­è¿è¡Œ
- âœ… æ•°æ®åº“ diom_workflow å·²åˆ›å»º
- âœ… è´¦å·ï¼šrootï¼Œå¯†ç ï¼š1qaz2wsx
- âœ… æ•°æ®å·²æ’å…¥

---

## æ–¹å¼ä¸€ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆæ¨èï¼‰

### æ­¥éª¤ 1: æ›´æ–°å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœç”¨æˆ·å¯†ç ä¸æ­£ç¡®ï¼Œå…ˆæ›´æ–°å¯†ç ï¼š

```bash
mysql -h localhost -P 3306 -u root -p1qaz2wsx < update_passwords.sql
```

### æ­¥éª¤ 2: è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

```bash
cd /Users/yanchao/IdeaProjects/diom-workFlow/diom-auth-service
chmod +x START_AND_TEST.sh
./START_AND_TEST.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. âœ… æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. âœ… ç¼–è¯‘é¡¹ç›®
3. âœ… å¯åŠ¨æœåŠ¡ï¼ˆåå°ï¼‰
4. âœ… ç­‰å¾…æœåŠ¡å°±ç»ª
5. âœ… è¿è¡ŒåŠŸèƒ½æµ‹è¯•

---

## æ–¹å¼äºŒï¼šæ‰‹åŠ¨æµ‹è¯•

### æµ‹è¯• 1: æ£€æŸ¥æ•°æ®åº“è¿æ¥

```bash
mysql -h localhost -P 3306 -u root -p1qaz2wsx -e "USE diom_workflow; SELECT * FROM sys_user;"
```

**é¢„æœŸè¾“å‡º**ï¼šæ˜¾ç¤º admin å’Œ test ä¸¤ä¸ªç”¨æˆ·

---

### æµ‹è¯• 2: å¯åŠ¨æœåŠ¡

#### é€‰é¡¹ Aï¼šå‰å°å¯åŠ¨ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰

```bash
cd /Users/yanchao/IdeaProjects/diom-workFlow/diom-auth-service
mvn spring-boot:run
```

#### é€‰é¡¹ Bï¼šåå°å¯åŠ¨

```bash
cd /Users/yanchao/IdeaProjects/diom-workFlow/diom-auth-service
nohup mvn spring-boot:run > logs/startup.log 2>&1 &
echo $! > service.pid
```

æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
tail -f logs/startup.log
```

åœæ­¢æœåŠ¡ï¼š
```bash
kill $(cat service.pid)
```

---

### æµ‹è¯• 3: åŠŸèƒ½æµ‹è¯•

ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆï¼ˆçœ‹åˆ° "Auth è®¤è¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼"ï¼‰ï¼Œç„¶ååœ¨**æ–°çš„ç»ˆç«¯çª—å£**è¿è¡Œï¼š

#### 3.1 å¥åº·æ£€æŸ¥

```bash
curl http://localhost:8081/health
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": "Auth Service is running",
  "timestamp": 1705201234567
}
```

---

#### 3.2 ç”¨æˆ·ç™»å½•

```bash
curl -X POST http://localhost:8081/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 7200,
    "user": {
      "id": 1,
      "username": "admin",
      "nickname": "ç®¡ç†å‘˜",
      "email": "admin@diom.com"
    }
  }
}
```

**å¦‚æœç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"**ï¼š
- è¿è¡Œ `mysql -h localhost -P 3306 -u root -p1qaz2wsx < update_passwords.sql`
- é‡å¯æœåŠ¡

---

#### 3.3 Token éªŒè¯

```bash
# å…ˆç™»å½•è·å– token
TOKEN=$(curl -s -X POST http://localhost:8081/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# éªŒè¯ token
curl http://localhost:8081/validate \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "Token æœ‰æ•ˆ",
  "data": {
    "userId": 1
  }
}
```

---

#### 3.4 Token åˆ·æ–°

```bash
curl -X POST http://localhost:8081/refresh \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "Token åˆ·æ–°æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9..."
  }
}
```

---

#### 3.5 ç”¨æˆ·æ³¨å†Œ

```bash
curl -X POST http://localhost:8081/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "zhangsan",
    "password": "123456",
    "nickname": "å¼ ä¸‰",
    "email": "zhangsan@example.com"
  }'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": null
}
```

---

## æ–¹å¼ä¸‰ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

å¦‚æœæœåŠ¡å·²ç»å¯åŠ¨ï¼Œç›´æ¥è¿è¡Œï¼š

```bash
cd /Users/yanchao/IdeaProjects/diom-workFlow/diom-auth-service
chmod +x QUICK_TEST.sh
./QUICK_TEST.sh
```

---

## å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯**: `Communications link failure`

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ Docker å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps | grep mysql

# æ£€æŸ¥ç«¯å£æ˜ å°„
docker port <container_id>

# æµ‹è¯•è¿æ¥
mysql -h localhost -P 3306 -u root -p1qaz2wsx -e "SELECT 1"
```

---

### Q2: ç™»å½•å¤±è´¥ - ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯

**åŸå› **: æ•°æ®åº“ä¸­çš„å¯†ç ä¸æ˜¯æ­£ç¡®çš„ BCrypt åŠ å¯†å€¼

**è§£å†³**ï¼š
```bash
# è¿è¡Œå¯†ç æ›´æ–°è„šæœ¬
mysql -h localhost -P 3306 -u root -p1qaz2wsx < update_passwords.sql

# æˆ–è€…æ‰‹åŠ¨ç”Ÿæˆå¯†ç 
cd /Users/yanchao/IdeaProjects/diom-workFlow/diom-auth-service
mvn test -Dtest=PasswordEncoderTest#generatePassword
```

---

### Q3: ç«¯å£ 8081 è¢«å ç”¨

**æ£€æŸ¥å ç”¨**ï¼š
```bash
lsof -i:8081
```

**æ€æ‰è¿›ç¨‹**ï¼š
```bash
kill -9 <PID>
```

---

### Q4: Maven ç¼–è¯‘å¤±è´¥

**æ£€æŸ¥ diom-common æ˜¯å¦å·²å®‰è£…**ï¼š
```bash
cd /Users/yanchao/IdeaProjects/diom-workFlow/diom-common
mvn clean install
```

---

## æµ‹è¯•æˆåŠŸæ ‡å¿—

çœ‹åˆ°ä»¥ä¸‹å†…å®¹è¡¨ç¤ºæµ‹è¯•æˆåŠŸï¼š

- âœ… å¥åº·æ£€æŸ¥è¿”å› 200
- âœ… ç™»å½•æˆåŠŸï¼Œè¿”å› token
- âœ… Token éªŒè¯æˆåŠŸï¼Œè¿”å› userId
- âœ… Token åˆ·æ–°æˆåŠŸï¼Œè¿”å›æ–° token
- âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ

---

## åœæ­¢æœåŠ¡

### å‰å°è¿è¡Œ
æŒ‰ `Ctrl + C`

### åå°è¿è¡Œ
```bash
# æ‰¾åˆ°è¿›ç¨‹
ps aux | grep diom-auth-service

# æˆ–è€…ä½¿ç”¨ä¿å­˜çš„ PID
kill $(cat service.pid)

# å¼ºåˆ¶åœæ­¢
pkill -f diom-auth-service
```

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸ‰

